# æœåŠ¡ç«¯è¿è¡Œè°ƒè¯•æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹ (5åˆ†é’Ÿä¸Šæ‰‹)

### ä¸€é”®æµ‹è¯•è„šæœ¬
```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd UpdatePlugin

# 2. è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
./docs/2-æŠ€æœ¯è§„èŒƒ/å¿«é€Ÿæµ‹è¯•è„šæœ¬.sh
```

### æ‰‹åŠ¨å¿«é€Ÿå¯åŠ¨
```bash
# 1. è¿›å…¥æœåŠ¡ç«¯ç›®å½•
cd Server

# 2. å¯åŠ¨æœåŠ¡
mvn spring-boot:run

# 3. æµ‹è¯•è¿é€šæ€§ (æ–°å¼€ç»ˆç«¯)
curl http://localhost:8080/

# 4. æµ‹è¯•API (ä½¿ç”¨çœŸå®APKæ–‡ä»¶)
curl -X POST \
  -H "X-API-Key: your-secret-api-key" \
  -F "apkFile=@../apk_uploads/UnifySign_productRelease_v1.1.8001.apk" \
  -F "appId=com.unifysign.android" \
  http://localhost:8080/api/admin/app/upload
```

---

## ğŸ“‹ ç›®å½•
- [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
- [å¿«é€Ÿå¯åŠ¨](#å¿«é€Ÿå¯åŠ¨)
- [å…³é”®é…ç½®è¯´æ˜](#å…³é”®é…ç½®è¯´æ˜)
- [æ¥å£æµ‹è¯•æŒ‡å—](#æ¥å£æµ‹è¯•æŒ‡å—)
- [å¸¸è§é—®é¢˜è§£å†³](#å¸¸è§é—®é¢˜è§£å†³)
- [å¼€å‘è°ƒè¯•æŠ€å·§](#å¼€å‘è°ƒè¯•æŠ€å·§)

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### å¿…éœ€è½¯ä»¶
- **Java 11+** (æ¨èä½¿ç”¨Java 11æˆ–17)
- **Maven 3.6+** (ç”¨äºæ„å»ºå’Œè¿è¡Œé¡¹ç›®)
- **Git** (ç”¨äºä»£ç ç®¡ç†)

### ç¯å¢ƒæ£€æŸ¥å‘½ä»¤
```bash
# æ£€æŸ¥Javaç‰ˆæœ¬
java -version

# æ£€æŸ¥Mavenç‰ˆæœ¬
mvn -version

# æ£€æŸ¥Gitç‰ˆæœ¬
git --version
```

### å®‰è£…æŒ‡å— (macOS)
```bash
# å®‰è£…Homebrew (å¦‚æœæ²¡æœ‰)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# å®‰è£…Java 11
brew install openjdk@11

# å®‰è£…Maven
brew install maven

# å®‰è£…Git
brew install git
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. è·å–ä»£ç 
```bash
# å…‹éš†é¡¹ç›® (å¦‚æœæ˜¯ä»Gitä»“åº“)
git clone <your-repository-url>
cd UpdatePlugin

# æˆ–è€…ç›´æ¥è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/UpdatePlugin
```

### 2. è¿›å…¥æœåŠ¡ç«¯ç›®å½•
```bash
cd Server
```

### 3. å¯åŠ¨æœåŠ¡
```bash
# æ–¹å¼1: ä½¿ç”¨Mavenç›´æ¥è¿è¡Œ (æ¨èå¼€å‘ç¯å¢ƒ)
mvn spring-boot:run

# æ–¹å¼2: å…ˆç¼–è¯‘å†è¿è¡Œ
mvn clean compile
mvn spring-boot:run

# æ–¹å¼3: æ‰“åŒ…åè¿è¡Œ (æ¨èç”Ÿäº§ç¯å¢ƒ)
mvn clean package
java -jar target/app-update-server-0.0.1-SNAPSHOT.jar
```

### 4. éªŒè¯å¯åŠ¨æˆåŠŸ
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨ (åº”è¯¥è¿”å›404ï¼Œè¯´æ˜æœåŠ¡æ­£å¸¸)
curl http://localhost:8080/

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
lsof -i :8080
```

## âš™ï¸ å…³é”®é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ä½ç½®
- **ä¸»é…ç½®æ–‡ä»¶**: `Server/src/main/resources/application.yml`
- **å¼€å‘ç¯å¢ƒ**: é»˜è®¤é…ç½®
- **ç”Ÿäº§ç¯å¢ƒ**: `spring.profiles.active=prod`

### ğŸ”‘ é‡è¦é…ç½®é¡¹

#### 1. æœåŠ¡å™¨é…ç½®
```yaml
server:
  port: 8080                    # æœåŠ¡ç«¯å£ï¼Œå¯ä¿®æ”¹ä¸ºå…¶ä»–ç«¯å£
  servlet:
    context-path: /             # åº”ç”¨æ ¹è·¯å¾„
```

#### 2. æ•°æ®åº“é…ç½®
```yaml
spring:
  datasource:
    # å¼€å‘ç¯å¢ƒ - H2æ•°æ®åº“ (é»˜è®¤)
    url: jdbc:h2:file:./database/app_update_db
    username: sa
    password: 
    
    # ç”Ÿäº§ç¯å¢ƒ - MySQLæ•°æ®åº“
    # url: jdbc:mysql://localhost:3306/app_update_db
    # username: your_username
    # password: your_password
```

#### 3. æ–‡ä»¶ä¸Šä¼ é…ç½®
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 500MB      # å•ä¸ªæ–‡ä»¶æœ€å¤§å¤§å°
      max-request-size: 500MB   # è¯·æ±‚æœ€å¤§å¤§å°
```

#### 4. åº”ç”¨è‡ªå®šä¹‰é…ç½®
```yaml
app:
  upload-path: ./apk_uploads/                    # APKæ–‡ä»¶å­˜å‚¨è·¯å¾„
  db-path: ./database/                           # H2æ•°æ®åº“æ–‡ä»¶è·¯å¾„
  server-base-url: http://localhost:8080         # æœåŠ¡å™¨åŸºç¡€URL
  admin:
    api-key: your-secret-api-key                 # ğŸ”‘ ç®¡ç†APIå¯†é’¥ (é‡è¦!)
```

### ğŸ” å®‰å…¨é…ç½®

#### APIå¯†é’¥è®¾ç½®
**é»˜è®¤å¯†é’¥**: `your-secret-api-key`

**ä¿®æ”¹æ–¹å¼**:
1. **é…ç½®æ–‡ä»¶ä¿®æ”¹**: ç¼–è¾‘ `application.yml`
```yaml
app:
  admin:
    api-key: your-new-secret-key
```

2. **ç¯å¢ƒå˜é‡è®¾ç½®** (æ¨èç”Ÿäº§ç¯å¢ƒ):
```bash
export ADMIN_API_KEY=your-production-secret-key
mvn spring-boot:run
```

3. **å¯åŠ¨å‚æ•°è®¾ç½®**:
```bash
mvn spring-boot:run -Dspring-boot.run.arguments="--app.admin.api-key=your-new-key"
```

## ğŸ§ª æ¥å£æµ‹è¯•æŒ‡å—

### æµ‹è¯•å·¥å…·æ¨è
- **å‘½ä»¤è¡Œ**: curl
- **å›¾å½¢ç•Œé¢**: Postman, Insomnia
- **åœ¨çº¿å·¥å…·**: Swagger UI (å¦‚æœå¯ç”¨)

### æ ¸å¿ƒæ¥å£æµ‹è¯•

#### 1. å¥åº·æ£€æŸ¥
```bash
# åŸºç¡€è¿é€šæ€§æµ‹è¯•
curl -i http://localhost:8080/
# é¢„æœŸ: 404 Not Found (è¯´æ˜æœåŠ¡æ­£å¸¸è¿è¡Œ)
```

#### 2. APKä¸Šä¼ æ¥å£

**å‡†å¤‡æµ‹è¯•æ–‡ä»¶**:
```bash
# ä½¿ç”¨çœŸå®çš„APKæ–‡ä»¶ (ä½äºapk_uploadsç›®å½•)
ls -la apk_uploads/UnifySign_productRelease_v1.1.8001.apk
```

**æ­£ç¡®çš„APIè°ƒç”¨**:
```bash
curl -X POST \
  -H "X-API-Key: your-secret-api-key" \
  -F "apkFile=@apk_uploads/UnifySign_productRelease_v1.1.8001.apk" \
  -F "appId=com.unifysign.android" \
  -F "updateDescription=UnifySignå®‰å…¨ç­¾åå·¥å…·v1.1.8001" \
  -F "forceUpdate=false" \
  http://localhost:8080/api/admin/app/upload
```

**é¢„æœŸå“åº”** (çœŸå®APKæ–‡ä»¶ä¼šè§£ææˆåŠŸ):
```json
{
  "code": 200,
  "message": "APKä¸Šä¼ æˆåŠŸ",
  "data": {
    "id": 1,
    "appId": "com.unifysign.android",
    "appName": "æ¡‚äº‘ç­¾",
    "packageName": "cn.org.bjca.signet.unify.app",
    "versionCode": 56,
    "versionName": "1.1.8001",
    "fileSize": 78083108,
    "md5": "d96f67fb6e2c8041cba9896ce7cbd8cb",
    "apkPath": "com.unifysign.android-56.apk",
    "downloadUrl": "http://localhost:8080/api/app/download/com.unifysign.android-56.apk",
    "updateDescription": "UnifySignå®‰å…¨ç­¾åå·¥å…·v1.1.8001",
    "forceUpdate": false,
    "status": 1,
    "statusDescription": "å¯ç”¨"
  },
  "timestamp": 1748581185153
}
```

#### 3. å®‰å…¨éªŒè¯æµ‹è¯•

**æ— APIå¯†é’¥æµ‹è¯•**:
```bash
curl -X POST \
  -F "apkFile=@test.apk" \
  http://localhost:8080/api/admin/app/upload
# é¢„æœŸ: 400 Bad Request
```

**é”™è¯¯APIå¯†é’¥æµ‹è¯•**:
```bash
curl -X POST \
  -H "X-API-Key: wrong-key" \
  -F "apkFile=@test.apk" \
  http://localhost:8080/api/admin/app/upload
# é¢„æœŸ: 400 Bad Request
```

### ğŸ¯ Postmanæµ‹è¯•é…ç½®

#### å¯¼å…¥æµ‹è¯•é›†åˆ (æ¨è)
1. **ä¸‹è½½é›†åˆæ–‡ä»¶**: `docs/2-æŠ€æœ¯è§„èŒƒ/Androidæ›´æ–°ç³»ç»ŸAPIæµ‹è¯•.postman_collection.json`
2. **å¯¼å…¥åˆ°Postman**:
   - æ‰“å¼€Postman
   - ç‚¹å‡» "Import" æŒ‰é’®
   - é€‰æ‹©ä¸‹è½½çš„JSONæ–‡ä»¶
   - å¯¼å…¥æˆåŠŸåä¼šçœ‹åˆ°å®Œæ•´çš„æµ‹è¯•é›†åˆ

#### æ‰‹åŠ¨åˆ›å»ºPostmanè¯·æ±‚
1. **æ–¹æ³•**: POST
2. **URL**: `http://localhost:8080/api/admin/app/upload`
3. **Headers**:
   ```
   X-API-Key: your-secret-api-key
   ```
4. **Body** (form-data):
   ```
   apkFile: [é€‰æ‹©APKæ–‡ä»¶]
   appId: com.example.testapp
   updateDescription: æµ‹è¯•ç‰ˆæœ¬
   forceUpdate: false
   ```

## ğŸ› å¸¸è§é—®é¢˜è§£å†³

### 1. ç«¯å£è¢«å ç”¨
**é”™è¯¯**: `Port 8080 was already in use`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :8080

# æ€æ­»è¿›ç¨‹ (æ›¿æ¢PID)
kill -9 <PID>

# æˆ–è€…ä¿®æ”¹ç«¯å£
mvn spring-boot:run -Dspring-boot.run.arguments="--server.port=8081"
```

### 2. Javaç‰ˆæœ¬ä¸å…¼å®¹
**é”™è¯¯**: `Unsupported class file major version`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥Javaç‰ˆæœ¬
java -version

# å¦‚æœç‰ˆæœ¬ä½äº11ï¼Œéœ€è¦å‡çº§
brew install openjdk@11
export JAVA_HOME=/opt/homebrew/opt/openjdk@11/libexec/openjdk.jdk/Contents/Home
```

### 3. Mavenå‘½ä»¤æ‰¾ä¸åˆ°
**é”™è¯¯**: `mvn: command not found`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å®‰è£…Maven
brew install maven

# æˆ–è€…ä½¿ç”¨é¡¹ç›®è‡ªå¸¦çš„Maven Wrapper (å¦‚æœæœ‰)
./mvnw spring-boot:run
```

### 4. æ•°æ®åº“è¿æ¥å¤±è´¥
**é”™è¯¯**: `Failed to configure a DataSource`

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥H2æ•°æ®åº“æ–‡ä»¶æƒé™
- ç¡®ä¿ `database` ç›®å½•å¯å†™
- æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“è·¯å¾„

### 5. æ–‡ä»¶ä¸Šä¼ å¤±è´¥
**é”™è¯¯**: `Maximum upload size exceeded`

**è§£å†³æ–¹æ¡ˆ**:
ä¿®æ”¹ `application.yml`:
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 1GB
      max-request-size: 1GB
```

## ğŸ” å¼€å‘è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/app-update-server.log

# æˆ–è€…åœ¨æ§åˆ¶å°æŸ¥çœ‹ (mvn spring-boot:run)
# æ—¥å¿—ä¼šç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°
```

### 2. æ•°æ®åº“ç®¡ç†

#### H2æ•°æ®åº“æ§åˆ¶å°
1. å¯åŠ¨åº”ç”¨åè®¿é—®: http://localhost:8080/h2-console
2. è¿æ¥ä¿¡æ¯:
   - **JDBC URL**: `jdbc:h2:file:./database/app_update_db`
   - **ç”¨æˆ·å**: `sa`
   - **å¯†ç **: (ç©º)

#### æŸ¥çœ‹æ•°æ®è¡¨
```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨
SHOW TABLES;

-- æŸ¥çœ‹åº”ç”¨ä¿¡æ¯
SELECT * FROM APP_INFO;

-- æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
SELECT * FROM APP_VERSION;
```

### 3. é…ç½®ä¸åŒç¯å¢ƒ

#### å¼€å‘ç¯å¢ƒ (é»˜è®¤)
```bash
mvn spring-boot:run
```