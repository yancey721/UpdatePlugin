# 数据库清理操作指南

## 概述

本指南提供了清理测试数据的多种方法，包括数据库数据清理和APK文件清理。

## 清理脚本说明

### 1. `reset_database.sh` - 快速重置（推荐）

**用途**: 完全重置数据库和APK文件，恢复到初始状态

**特点**:
- ✅ 简单快速
- ✅ 彻底清理
- ✅ 自动检查服务器状态
- ✅ 保留README.md文档

**使用方法**:
```bash
cd Server
./reset_database.sh
```

**执行步骤**:
1. 检查服务器是否运行（如果运行会提示停止）
2. 删除所有H2数据库文件
3. 清理所有APK文件
4. 保留目录结构和文档

### 2. `clear_test_data.sh` - 高级清理

**用途**: 保留数据库结构，只清理数据内容

**特点**:
- ✅ 保留数据库结构
- ✅ 只清理数据内容
- ✅ 尝试使用H2工具执行SQL
- ✅ 详细的清理报告

**使用方法**:
```bash
cd Server
./clear_test_data.sh
```

**执行步骤**:
1. 检查数据库连接
2. 使用SQL脚本清理数据（如果可能）
3. 清理APK文件
4. 清理临时文件
5. 显示清理结果

### 3. `clear_database.sql` - 纯SQL清理

**用途**: 手动执行的SQL清理脚本

**使用场景**:
- 通过H2控制台手动执行
- 集成到其他工具中
- 自定义清理逻辑

**使用方法**:
1. 启动服务器
2. 访问 http://localhost:8080/h2-console
3. 连接数据库
4. 执行 `clear_database.sql` 中的SQL语句

## 使用建议

### 开发阶段
推荐使用 `reset_database.sh`：
```bash
./reset_database.sh
```

### 生产环境
谨慎使用，建议：
1. 先备份重要数据
2. 使用 `clear_test_data.sh` 进行选择性清理
3. 或手动执行SQL脚本

### 测试环境
可以频繁使用 `reset_database.sh` 快速重置

## 清理内容

### 数据库清理
- `app_info` 表：应用信息
- `app_version` 表：应用版本信息
- 重置自增ID

### 文件清理
- 删除所有 `.apk` 文件
- 删除空的应用目录
- 保留 `README.md` 文档
- 清理临时文件

## 注意事项

### ⚠️ 重要提醒
1. **停止服务器**: 清理前请确保服务器已停止
2. **数据备份**: 生产环境请先备份重要数据
3. **权限检查**: 确保有足够的文件操作权限

### 🔧 故障排除

**问题**: 脚本执行失败
**解决**: 检查文件权限
```bash
chmod +x *.sh
```

**问题**: 数据库文件被锁定
**解决**: 确保服务器已完全停止
```bash
pkill -f spring-boot
```

**问题**: APK文件删除失败
**解决**: 检查文件权限和磁盘空间

## 验证清理结果

### 检查数据库
```bash
ls -la database/
```
应该只看到 `.lock.db` 文件（如果有）

### 检查APK文件
```bash
find ../apk_uploads -name "*.apk" | wc -l
```
应该返回 `0`

### 重启验证
```bash
mvn spring-boot:run
```
服务器启动后应该创建新的空数据库

## 自动化集成

可以将清理脚本集成到CI/CD流程中：

```bash
# 测试前清理
./reset_database.sh

# 运行测试
mvn test

# 测试后清理
./reset_database.sh
```

## 总结

- **快速重置**: 使用 `reset_database.sh`
- **保留结构**: 使用 `clear_test_data.sh`  
- **手动控制**: 使用 `clear_database.sql`
- **生产环境**: 谨慎操作，先备份 